# Codebase Structure

**Analysis Date:** 2026-02-21

## Directory Layout

```
agent-bureau/
├── src/
│   └── disagree_v1/           # Main package
│       ├── __init__.py         # Package marker
│       ├── orchestrator.py      # Fan-out/fan-in orchestration
│       ├── adapters.py          # Agent execution adapters
│       ├── classifier.py        # Disagreement classification
│       ├── models.py            # Frozen dataclasses
│       ├── store.py             # JSONL persistence
│       ├── adjudication.py      # Follow-up prompt builders
│       ├── presets.py           # Command template presets
│       ├── cli.py               # CLI entry point
│       ├── launcher.py          # Interactive launcher logic
│       └── launch.py            # Interactive launcher entry point
├── schemas/
│   └── agent_response.schema.json  # JSON Schema for agent output
├── tests/
│   └── test_v1_flow.py        # Unit and integration tests
├── .planning/
│   └── codebase/              # Generated architecture docs
├── pyproject.toml             # Python project metadata
├── README.md                  # User guide
├── CLAUDE.md                  # Development principles
└── .disagree/                 # Runtime directory (created at execution)
    ├── sessions.jsonl         # Append-only session log
    └── agents.json            # Saved agent config
```

## Directory Purposes

**src/disagree_v1:**
- Purpose: Main orchestration package for dual-agent disagreement analysis
- Contains: All production code
- Key files: orchestrator.py (entry point for core logic), adapters.py (agent integration), models.py (schema definitions)

**schemas/**
- Purpose: JSON Schema definitions for agent output validation
- Contains: `agent_response.schema.json` - required fields (answer, proposed_actions, assumptions, confidence)
- Used by: Codex preset command (`--output-schema`), client-side validation, documentation

**tests/**
- Purpose: Unit and integration test suite
- Contains: Single test file covering orchestrator, classifiers, adapters, persistence, launcher utilities
- Test count: 22 test methods covering all major workflows and error cases

**.planning/codebase/**
- Purpose: Generated documentation for code navigation and future phases
- Contains: ARCHITECTURE.md, STRUCTURE.md, and future CONVENTIONS.md, TESTING.md, etc.
- Generated by: /gsd:map-codebase orchestrator command

**.disagree/**
- Purpose: Runtime state directory (gitignored)
- Contains: sessions.jsonl (append-only event log), agents.json (saved agent configuration)
- Created: Automatically by `JsonlSessionStore` on first use
- Committed: No (in .gitignore)

## Key File Locations

**Entry Points:**
- `src/disagree_v1/cli.py`: Argument-driven CLI entry (for batch automation)
- `src/disagree_v1/launch.py`: Interactive launcher entry (for human-guided setup)

**Configuration:**
- `schemas/agent_response.schema.json`: Agent output schema validation
- `pyproject.toml`: Python version, dependencies, pytest config

**Core Logic:**
- `src/disagree_v1/orchestrator.py`: `DisagreementOrchestrator` - main orchestration
- `src/disagree_v1/adapters.py`: `StubAgentAdapter`, `CommandJsonAdapter` - agent integration
- `src/disagree_v1/classifier.py`: `classify_disagreements()` - disagreement detection
- `src/disagree_v1/models.py`: `AgentResponse`, `Disagreement`, `SessionResult` - data schemas

**Persistence:**
- `src/disagree_v1/store.py`: `JsonlSessionStore` - append-only JSONL logging

**Adjudication:**
- `src/disagree_v1/adjudication.py`: `build_reconcile_prompt()`, `build_debate_prompt()`, `apply_action()` - follow-up logic

**Launcher UI:**
- `src/disagree_v1/launcher.py`: Agent detection, config save/load, interactive prompts
- `src/disagree_v1/presets.py`: `build_claude_codex_commands()` - template builders

**Testing:**
- `tests/test_v1_flow.py`: 22 test cases covering all layers

## Naming Conventions

**Files:**
- `orchestrator.py`: Single class, named after responsibility
- `adapters.py`: Multiple related adapter classes
- `classifier.py`: Single function or tightly coupled functions
- `models.py`: Data model classes only
- `store.py`: Single persistence class
- `cli.py`, `launch.py`, `launcher.py`: Entry points
- `test_*.py`: Test discovery pattern (unittest)

**Directories:**
- `src/`: Source code
- `schemas/`: External schema definitions
- `tests/`: Test files (mirroring src structure not required)
- `.planning/codebase/`: Documentation outputs

**Modules:**
- Package: `disagree_v1`
- No subpackages; flat structure within `src/disagree_v1/`

**Classes:**
- PascalCase: `DisagreementOrchestrator`, `AgentResponse`, `JsonlSessionStore`
- Protocol-based duck typing: `AgentAdapter` (Protocol)
- Test fakes: `FakeAdapter`, `TrackingOrchestrator`

**Functions:**
- snake_case: `classify_disagreements()`, `build_reconcile_prompt()`, `apply_action()`
- Private functions prefixed with `_`: `_build_args()`, `_parse_payload()`, `_normalize()`, `_inline_schema()`, `_print_result()`

**Variables:**
- snake_case: `agent_a`, `proposed_actions`, `confidence_gap`, `debate_index`
- Constants (module-level): UPPERCASE: `CONFIDENCE_GAP_THRESHOLD`

**Dataclass Fields:**
- snake_case: `answer`, `proposed_actions`, `assumptions`, `confidence`, `agent_a`, `agent_b`

## Where to Add New Code

**New Feature (e.g., new disagreement type):**
- Primary code: `src/disagree_v1/classifier.py` - add classification logic to `classify_disagreements()`
- Models: Update `Disagreement.kind` enum or add new field to `src/disagree_v1/models.py`
- Tests: `tests/test_v1_flow.py` - add test case to `V1FlowTests` class

**New Follow-Up Action:**
- Prompt builders: `src/disagree_v1/adjudication.py` - add `build_[action]_prompt()` function
- Action dispatcher: Update `apply_action()` in `src/disagree_v1/adjudication.py`
- CLI options: Update `_build_parser()` in `src/disagree_v1/cli.py` (add to --action choices)
- Tests: `tests/test_v1_flow.py` - add test to validate action flow

**New Adapter Type:**
- Adapter class: `src/disagree_v1/adapters.py` - implement `AgentAdapter` protocol
- Instantiation: `src/disagree_v1/cli.py` or `src/disagree_v1/launcher.py` - add mode condition
- Tests: `tests/test_v1_flow.py` - add fake adapter and test case

**New Preset:**
- Builder function: `src/disagree_v1/presets.py` - add `build_[name]_commands()` function
- CLI integration: `src/disagree_v1/cli.py` - add preset name to `--preset` choices, call builder
- Documentation: `README.md` - document usage

**Utilities:**
- Shared helpers: `src/disagree_v1/[module].py` - add function to relevant module (or new module if cross-cutting)
- No separate utils/ directory; keep flat structure

## Special Directories

**src/disagree_v1/__pycache__:**
- Purpose: Python bytecode cache
- Generated: Yes (by Python runtime)
- Committed: No (in .gitignore)

**.disagree/**
- Purpose: Runtime state (sessions and configuration)
- Generated: Yes (by `JsonlSessionStore` and launcher)
- Committed: No (in .gitignore, user-local)

**tests/__pycache__:**
- Purpose: Test bytecode cache
- Generated: Yes (by pytest/unittest)
- Committed: No (in .gitignore)

**.venv/**
- Purpose: Python virtual environment
- Generated: Yes (by `python3 -m venv`)
- Committed: No (in .gitignore)

**.planning/codebase/**
- Purpose: Generated documentation from /gsd:map-codebase
- Generated: Yes (by orchestrator commands)
- Committed: Yes (tracking documentation)

## Module Import Structure

**Dependency Graph (simplified):**

```
cli.py, launch.py
  ↓
launcher.py → adapters.py, orchestrator.py, adjudication.py, presets.py
              ↓
              orchestrator.py → adapters.py, classifier.py, models.py, store.py

classifier.py → models.py
adapters.py → models.py
adjudication.py → models.py
store.py (no cross-module deps)
models.py (no cross-module deps)
presets.py (no cross-module deps)
```

No circular dependencies. Acyclic dependency graph.

## How to Run

**Stub mode (deterministic, for testing):**
```bash
PYTHONPATH=src python3 -m disagree_v1.cli "Your prompt here"
```

**Interactive launcher (human-guided):**
```bash
PYTHONPATH=src python3 -m disagree_v1.launch
```

**Command mode with custom agents:**
```bash
PYTHONPATH=src python3 -m disagree_v1.cli "Your prompt" \
  --mode command \
  --agent-a-cmd 'command-a {prompt}' \
  --agent-b-cmd 'command-b {prompt}'
```

**Tests:**
```bash
PYTHONPATH=src python3 -m unittest discover -s tests -p 'test_*.py'
```

Or with pytest:
```bash
pytest tests/ -v
```
