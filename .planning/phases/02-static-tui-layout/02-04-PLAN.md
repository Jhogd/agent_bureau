---
phase: 02-static-tui-layout
plan: "04"
type: execute
wave: 3
depends_on:
  - "02-03"
files_modified:
  - src/tui/app.py
  - tests/tui/test_app.py
autonomous: false
requirements:
  - TUI-07
  - TUI-08

must_haves:
  truths:
    - "Left pane (pane-left) has focus on startup — arrow keys work immediately without pressing Tab"
    - "Right arrow key switches focus to the right pane; left arrow key returns focus to the left pane"
    - "Up/down arrow keys scroll only the currently focused pane — the other pane does not move"
    - "Pressing q exits the app cleanly with no error output"
    - "Pressing Ctrl-C pushes the QuitScreen confirmation dialog"
    - "Confirming quit in the dialog exits the app; cancelling returns to the TUI"
    - "Layout renders at 80, 120, and wide terminal widths with two visible equal-width panes"
    - "User can visually confirm the layout looks correct with placeholder content loaded"
  artifacts:
    - path: "src/tui/app.py"
      provides: "AgentBureauApp(App) — full wired application entry point"
      exports: ["AgentBureauApp"]
    - path: "tests/tui/test_app.py"
      provides: "Pilot-based integration tests for layout, navigation, and exit"
      min_lines: 80
  key_links:
    - from: "src/tui/app.py"
      to: "src/tui/widgets/agent_pane.py"
      via: "from tui.widgets.agent_pane import AgentPane"
      pattern: "from tui\\.widgets\\.agent_pane import AgentPane"
    - from: "src/tui/app.py"
      to: "src/tui/widgets/quit_screen.py"
      via: "from tui.widgets.quit_screen import QuitScreen"
      pattern: "from tui\\.widgets\\.quit_screen import QuitScreen"
    - from: "src/tui/app.py"
      to: "src/tui/styles.tcss"
      via: "CSS_PATH = Path(__file__).parent / 'styles.tcss'"
      pattern: "CSS_PATH.*styles\\.tcss"
    - from: "tests/tui/test_app.py"
      to: "src/tui/app.py"
      via: "from tui.app import AgentBureauApp"
      pattern: "from tui\\.app import AgentBureauApp"
---

<objective>
Wire AgentBureauApp together: compose the two AgentPane columns with the vertical divider, implement keyboard bindings for pane navigation and exit, load placeholder content into both panes, and prove the complete layout and interaction model with Pilot-based integration tests. Ends with a human visual checkpoint.

Purpose: This is the final assembly step. The widgets are proven individually in plan 03; this plan wires them into the runnable application and validates the end-to-end keyboard UX.
Output: `src/tui/app.py` (runnable TUI) + `tests/tui/test_app.py` (layout/nav/exit tests) + human visual sign-off.
</objective>

<execution_context>
@/Users/jakeogden/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakeogden/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-static-tui-layout/02-03-SUMMARY.md
@src/tui/widgets/agent_pane.py
@src/tui/widgets/quit_screen.py
@src/tui/styles.tcss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement AgentBureauApp and integration tests</name>
  <files>
    src/tui/app.py
    tests/tui/test_app.py
  </files>
  <action>
**1. Create `src/tui/app.py`:**

```python
"""AgentBureauApp — the main Textual application for Agent Bureau.

Layout: two AgentPane columns separated by a single-character vertical divider,
filling the full terminal height. Left pane focuses on startup.

Keyboard bindings:
  left / right  — switch pane focus
  up / down     — scroll focused pane (handled by AgentPane, NOT here)
  q             — exit immediately
  ctrl+c        — push QuitScreen confirmation dialog
"""
from pathlib import Path
from textual.app import App, ComposeResult
from textual.binding import Binding
from textual.containers import Horizontal
from textual.widgets import Static

from tui.widgets.agent_pane import AgentPane
from tui.widgets.quit_screen import QuitScreen

# Placeholder content for Phase 2 validation — replaced by live streaming in Phase 3
_PLACEHOLDER_CONTENT = """\
This is example agent output for layout validation.

Here is some prose describing an approach to the problem.
The agent would normally stream this content token by token.

```python
def solve(n: int) -> int:
    \"\"\"Example code block for syntax highlight validation.\"\"\"
    if n <= 1:
        return n
    return solve(n - 1) + solve(n - 2)
```

After the code block, prose continues here.
Use `left` and `right` arrow keys to switch panes.
Use `up` and `down` arrow keys to scroll this pane.
Press `q` to quit, or `Ctrl-C` for a confirmation dialog.
"""


class AgentBureauApp(App):
    """Side-by-side columnar TUI for comparing agent responses."""

    CSS_PATH = Path(__file__).parent / "styles.tcss"

    BINDINGS = [
        Binding("left", "focus_left", "Left pane", show=False),
        Binding("right", "focus_right", "Right pane", show=False),
        Binding("q", "quit", "Quit"),
        Binding("ctrl+c", "confirm_quit", "Exit", priority=True),
    ]

    def compose(self) -> ComposeResult:
        with Horizontal():
            yield AgentPane(agent_name="claude", id="pane-left")
            yield Static("│", id="divider")
            yield AgentPane(agent_name="codex", id="pane-right")

    def on_mount(self) -> None:
        # Explicitly focus the left pane so arrow keys work immediately on startup.
        # Without this call, no pane is focused and key bindings are silent.
        self.query_one("#pane-left", AgentPane).focus()
        # Load placeholder content into both panes for Phase 2 layout validation.
        self.query_one("#pane-left", AgentPane).write_content(_PLACEHOLDER_CONTENT)
        self.query_one("#pane-right", AgentPane).write_content(_PLACEHOLDER_CONTENT)

    def action_focus_left(self) -> None:
        self.query_one("#pane-left", AgentPane).focus()

    def action_focus_right(self) -> None:
        self.query_one("#pane-right", AgentPane).focus()

    def action_quit(self) -> None:
        self.exit()

    def action_confirm_quit(self) -> None:
        self.push_screen(QuitScreen(), lambda result: self.exit() if result else None)


def main() -> None:
    """Entry point for the `agent-bureau` CLI command."""
    AgentBureauApp().run()


if __name__ == "__main__":
    main()
```

ANTI-PATTERNS to avoid (from research):
- Do NOT bind `up`/`down` in AgentBureauApp — those belong in AgentPane only. App-level up/down would fire regardless of focus and scroll both panes.
- Do NOT use `priority=True` on `left`/`right` — they should only fire when no other widget consumes them first.
- `ctrl+c` DOES use `priority=True` — this intercepts before Textual's built-in quit to show the confirmation dialog.

**2. Create `tests/tui/test_app.py`:**

```python
"""Integration tests for AgentBureauApp using Textual's headless Pilot harness.

Tests cover:
  - Layout: two panes and divider present at multiple terminal widths
  - Focus: left pane focused on startup; arrow keys switch focus
  - Scrolling: up/down scroll focused pane (does not crash)
  - Exit: q exits; ctrl+c pushes QuitScreen
"""
import pytest

from tui.app import AgentBureauApp
from tui.widgets.agent_pane import AgentPane


# --- Layout tests ---

@pytest.mark.asyncio
async def test_two_panes_and_divider_exist():
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        assert app.query_one("#pane-left") is not None
        assert app.query_one("#pane-right") is not None
        assert app.query_one("#divider") is not None


@pytest.mark.asyncio
async def test_panes_have_equal_width_at_120_columns():
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        left = app.query_one("#pane-left", AgentPane)
        right = app.query_one("#pane-right", AgentPane)
        # Each pane should be roughly half of 119 usable columns (1 for divider).
        # Allow +-2 for rounding.
        assert abs(left.size.width - right.size.width) <= 2


@pytest.mark.asyncio
async def test_layout_at_80_columns():
    app = AgentBureauApp()
    async with app.run_test(size=(80, 24)) as pilot:
        await pilot.pause()
        left = app.query_one("#pane-left", AgentPane)
        right = app.query_one("#pane-right", AgentPane)
        assert left.size.width > 30
        assert right.size.width > 30


@pytest.mark.asyncio
async def test_layout_at_200_columns():
    app = AgentBureauApp()
    async with app.run_test(size=(200, 50)) as pilot:
        await pilot.pause()
        left = app.query_one("#pane-left", AgentPane)
        right = app.query_one("#pane-right", AgentPane)
        assert left.size.width > 90
        assert right.size.width > 90


# --- Focus tests ---

@pytest.mark.asyncio
async def test_left_pane_focused_on_startup():
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        assert app.focused is not None
        assert app.focused.id == "pane-left"


@pytest.mark.asyncio
async def test_right_arrow_switches_focus_to_right_pane():
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        await pilot.press("right")
        await pilot.pause()
        assert app.focused.id == "pane-right"


@pytest.mark.asyncio
async def test_left_arrow_returns_focus_to_left_pane():
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        await pilot.press("right")
        await pilot.pause()
        await pilot.press("left")
        await pilot.pause()
        assert app.focused.id == "pane-left"


@pytest.mark.asyncio
async def test_repeated_right_arrow_stays_on_right_pane():
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        await pilot.press("right")
        await pilot.press("right")
        await pilot.pause()
        assert app.focused.id == "pane-right"


# --- Scroll tests ---

@pytest.mark.asyncio
async def test_up_down_arrows_do_not_crash():
    """Smoke test: scrolling the focused pane raises no exception."""
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        await pilot.press("down")
        await pilot.press("down")
        await pilot.press("up")
        await pilot.pause()
        # If we reach here without exception, the test passes.


@pytest.mark.asyncio
async def test_scroll_only_affects_focused_pane():
    """Pressing down on the left pane does not change right pane scroll position."""
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        from textual.widgets import RichLog
        await pilot.pause()
        right_log = app.query_one("#pane-right #content", RichLog)
        scroll_before = right_log.scroll_y
        # Focus left pane and scroll down
        await pilot.press("left")
        await pilot.pause()
        for _ in range(5):
            await pilot.press("down")
        await pilot.pause()
        assert right_log.scroll_y == scroll_before


# --- Exit tests ---

@pytest.mark.asyncio
async def test_q_exits_app():
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        await pilot.press("q")
        # App exits cleanly — run_test context exits without error


@pytest.mark.asyncio
async def test_ctrl_c_pushes_quit_screen():
    from tui.widgets.quit_screen import QuitScreen
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        await pilot.press("ctrl+c")
        await pilot.pause()
        # QuitScreen should be on the screen stack
        assert isinstance(app.screen, QuitScreen)


@pytest.mark.asyncio
async def test_cancel_in_quit_screen_returns_to_tui():
    from tui.widgets.quit_screen import QuitScreen
    app = AgentBureauApp()
    async with app.run_test(size=(120, 40)) as pilot:
        await pilot.pause()
        await pilot.press("ctrl+c")
        await pilot.pause()
        assert isinstance(app.screen, QuitScreen)
        await pilot.click("#cancel")
        await pilot.pause()
        # Back on the main screen — not QuitScreen
        assert not isinstance(app.screen, QuitScreen)
```

CRITICAL: Do NOT create `tests/tui/__init__.py`. The file must not exist.

After creating both files, run all tests:
```
pytest /Users/jakeogden/agent-bureau/tests/tui/test_app.py -v
pytest /Users/jakeogden/agent-bureau/tests/ -q
```

If tests fail, diagnose and fix in `src/tui/app.py` before proceeding to the checkpoint.
  </action>
  <verify>
```
pytest /Users/jakeogden/agent-bureau/tests/tui/test_app.py -v
```
All tests pass. Then:
```
pytest /Users/jakeogden/agent-bureau/tests/ -q
```
Full suite passes with no regressions. `ls /Users/jakeogden/agent-bureau/tests/tui/` shows NO `__init__.py`.
  </verify>
  <done>
`src/tui/app.py` exists with AgentBureauApp, `main()`, and placeholder content loaded in `on_mount()`. All integration tests in `tests/tui/test_app.py` pass. Full test suite passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of Phase 2 layout</name>
  <action>
Run the completed TUI in a real terminal to visually confirm the layout, keyboard navigation, and exit behaviors match the locked decisions from CONTEXT.md.

Open a terminal window outside this Claude Code session (Ctrl-C inside Claude Code would be intercepted), then run:

```
cd /Users/jakeogden/agent-bureau
python -m tui.app
```

Walk through all eight checks listed in how-to-verify. Report any visual issues so they can be fixed before Phase 3.
  </action>
  <verify>
In the live terminal, confirm all of the following:
1. Two named columns ("claude" | "codex") with placeholder content and a syntax-highlighted Python code block in each pane.
2. Left pane header brighter on startup; right pane header dimmed.
3. Right arrow key highlights the right header and dims the left.
4. Left arrow key returns focus to the left pane.
5. Up/Down arrows scroll only the focused pane.
6. Resizing the terminal keeps both panes equal-width with the divider visible.
7. `q` exits cleanly — terminal returns to normal state.
8. Ctrl-C shows "Are you sure you want to quit?" dialog; Cancel returns to TUI; Quit exits cleanly.
  </verify>
  <done>User types "approved" confirming all eight visual checks pass, or issues are reported and fixed.</done>
</task>

</tasks>

<verification>
Automated:
- `pytest /Users/jakeogden/agent-bureau/tests/tui/test_app.py -v` — all pass
- `pytest /Users/jakeogden/agent-bureau/tests/ -q` — full suite passes
- `ls /Users/jakeogden/agent-bureau/tests/tui/` — no `__init__.py`
- `grep "CSS_PATH" /Users/jakeogden/agent-bureau/src/tui/app.py` — references styles.tcss
- `grep "on_mount" /Users/jakeogden/agent-bureau/src/tui/app.py` — sets focus and writes placeholder

Human visual (from checkpoint):
- Two labeled panes visible side-by-side
- Syntax-highlighted Python code block renders in both panes
- Arrow key navigation works correctly
- q and Ctrl-C exit paths work as specified
</verification>

<success_criteria>
Phase 2 complete when:
1. All automated tests pass (test_content.py + test_agent_pane.py + test_quit_screen.py + test_app.py)
2. Human visual verification confirms the layout, highlighting, keyboard navigation, and exit behaviors match the locked decisions from CONTEXT.md
</success_criteria>

<output>
After completion, create `.planning/phases/02-static-tui-layout/02-04-SUMMARY.md` following the summary template.
</output>
