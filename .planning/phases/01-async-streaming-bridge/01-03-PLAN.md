---
phase: 01-async-streaming-bridge
plan: 03
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - spikes/pty_agent_spike.py
autonomous: true
requirements: [AGENT-03]

must_haves:
  truths:
    - "PTY vs PIPE streaming behavior for the real claude binary is documented with observed evidence"
    - "It is known whether claude CLI buffers stdout when not connected to a real TTY (PIPE mode)"
    - "The PTY fallback warning path works: RuntimeWarning is emitted when pty.openpty() is unavailable (simulated)"
  artifacts:
    - path: "spikes/pty_agent_spike.py"
      provides: "Standalone script that runs claude binary in PTY mode and PIPE mode, prints observed token arrival timing and buffering behavior"
      min_lines: 40
  key_links:
    - from: "spikes/pty_agent_spike.py"
      to: "real claude binary on PATH"
      via: "asyncio.create_subprocess_exec"
      pattern: "create_subprocess_exec.*claude"
---

<objective>
Spike the real claude CLI binary to document PTY vs PIPE streaming behavior. This closes the open question flagged in RESEARCH.md and STATE.md: "some CLI agents detect non-TTY stdout and disable streaming — needs a real spike per agent in Phase 1."

Purpose: AGENT-03 requires that agent timeout behavior is correct in production. Before Phase 3 wires the bridge to a live TUI, we must know whether PTY is actually required for the real claude binary (not just assumed). This spike produces evidence that informs Phase 3 bridge configuration.
Output: spikes/pty_agent_spike.py — a self-contained script; observations documented in the plan SUMMARY.
</objective>

<execution_context>
@/Users/jakeogden/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakeogden/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-async-streaming-bridge/01-CONTEXT.md
@.planning/phases/01-async-streaming-bridge/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write and run PTY agent spike script</name>
  <files>spikes/pty_agent_spike.py</files>
  <action>
    Create the `spikes/` directory if it does not exist. Write `spikes/pty_agent_spike.py` — a standalone asyncio script that:

    1. Checks whether `claude` is on PATH (shutil.which). If not, print a clear message and exit — do NOT crash.

    2. Defines `_pty_available()` using the pattern from RESEARCH.md (try pty.openpty(), close both fds, return True; OSError → return False).

    3. Implements a PTY streaming test:
       - Use the exact PTY pattern from RESEARCH.md: pty.openpty(), fcntl O_NONBLOCK on master, create_subprocess_exec with slave_fd as stdout/stderr, os.close(slave_fd) in parent immediately
       - Prompt to send: "Say exactly: STREAMING_OK" (short, deterministic)
       - Timeout: 15 seconds
       - Print each token chunk as it arrives, prefixed with timestamp: `[PTY +0.123s] <text>`
       - On completion, print: `PTY mode: {chunk_count} chunks in {elapsed:.2f}s, first chunk at +{first_chunk_delay:.3f}s`

    4. Implements a PIPE streaming test:
       - Use asyncio.subprocess.PIPE, async readline loop
       - Same prompt and timeout
       - Same timing output prefixed: `[PIPE +0.123s] <text>`
       - On completion: `PIPE mode: {chunk_count} chunks in {elapsed:.2f}s, first chunk at +{first_chunk_delay:.3f}s`

    5. Prints a summary comparison: whether first-chunk latency differs significantly between PTY and PIPE, and whether PIPE produced 0 chunks (buffering detected).

    Key implementation notes from RESEARCH.md that MUST be applied:
    - fcntl.fcntl(master_fd, fcntl.F_SETFL, flags | os.O_NONBLOCK) before loop.add_reader()
    - os.close(slave_fd) immediately after create_subprocess_exec
    - data.replace(b"\r\n", b"\n") normalization
    - proc.terminate() + await proc.wait() cleanup in finally
    - stdin=asyncio.subprocess.DEVNULL

    The script must be self-contained and runnable as: `python3 spikes/pty_agent_spike.py`
    No imports from tui/ package — this is a standalone spike.
  </action>
  <verify>
    Run: `python3 spikes/pty_agent_spike.py`

    If claude is on PATH:
    - Script runs without crashing
    - Timing output is printed for PTY mode
    - Timing output is printed for PIPE mode
    - Summary comparison is printed
    - Key observation recorded: did PIPE produce 0 tokens before process exit? (buffering = yes → PTY required)

    If claude is NOT on PATH:
    - Script prints "claude not found on PATH — spike cannot run with real binary" and exits cleanly (exit code 0)

    Either way: script exits without unhandled exception.
  </verify>
  <done>
    spikes/pty_agent_spike.py exists, is syntactically valid (python3 -m py_compile spikes/pty_agent_spike.py exits 0), and runs to completion with either real output or a clean "not found" message. The observed PTY vs PIPE behavior is captured in the SUMMARY.
  </done>
</task>

</tasks>

<verification>
1. `python3 -m py_compile spikes/pty_agent_spike.py` — exits 0 (no syntax errors)
2. `python3 spikes/pty_agent_spike.py` — exits 0 with output (real result or not-found message)
3. Script does NOT import from tui/ (grep confirms: `grep "from tui" spikes/pty_agent_spike.py` returns empty)
4. All existing tests still pass: `python3 -m pytest tests/ -q`
</verification>

<success_criteria>
- spikes/pty_agent_spike.py exists and is syntactically valid
- Script handles missing claude binary gracefully
- PTY and PIPE behavior comparison is observable from script output
- SUMMARY documents the observed behavior (PTY required / not required, first-chunk latency, buffering evidence)
- Existing tests unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/01-async-streaming-bridge/01-03-SUMMARY.md` with:
- Whether claude binary was available during spike
- Observed PTY mode: chunk count, first-chunk latency
- Observed PIPE mode: chunk count, first-chunk latency (0 chunks = buffering detected)
- Conclusion: PTY required for claude? (yes/no/unknown — with evidence)
- Recommendation for Phase 3 bridge default (USE_PTY = True confirmed / conditional)
- Any unexpected behavior observed
</output>
