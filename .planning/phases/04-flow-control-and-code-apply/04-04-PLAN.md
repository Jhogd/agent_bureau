---
phase: 04-flow-control-and-code-apply
plan: "04"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tui/widgets/reconciliation_panel.py
  - src/tui/widgets/status_bar.py
  - src/tui/styles.tcss
  - tests/tui/test_reconciliation_panel.py
autonomous: true
requirements:
  - APPLY-01
  - ORCH-04

must_haves:
  truths:
    - "ReconciliationPanel is hidden by default (display: none) and becomes visible after show_reconciliation() is called"
    - "ReconciliationPanel shows plain-text discussion and syntax-highlighted unified diff side by side in a RichLog"
    - "StatusBar has show_debating(), show_pick_winner(), show_reconciling(), and show_apply_confirm() methods"
    - "Phase 4 CSS rules are appended to styles.tcss without modifying existing Phase 3 rules"
  artifacts:
    - path: "src/tui/widgets/reconciliation_panel.py"
      provides: "ReconciliationPanel widget"
      contains: "ReconciliationPanel"
    - path: "src/tui/widgets/status_bar.py"
      provides: "Extended StatusBar with Phase 4 show_* methods"
      contains: "show_debating"
    - path: "src/tui/styles.tcss"
      provides: "Phase 4 CSS appended (OCP)"
      contains: "ReconciliationPanel"
    - path: "tests/tui/test_reconciliation_panel.py"
      provides: "Tests for ReconciliationPanel display behavior"
  key_links:
    - from: "src/tui/widgets/reconciliation_panel.py"
      to: "src/tui/app.py"
      via: "query_one(ReconciliationPanel).show_reconciliation(discussion, diff)"
      pattern: "ReconciliationPanel"
    - from: "src/tui/widgets/status_bar.py"
      to: "src/tui/app.py"
      via: "status_bar.show_debating(round_num)"
      pattern: "show_debating|show_pick_winner|show_reconciling|show_apply_confirm"
---

<objective>
Build ReconciliationPanel widget, extend StatusBar with Phase 4 state messages, and append Phase 4 CSS rules to styles.tcss.

Purpose: These are presentation-layer components that the app wiring plan (04-05) needs ready. ReconciliationPanel is hidden until reconciliation completes; it shows the agent discussion and unified diff. StatusBar methods keep the user informed during every Phase 4 state transition.
Output: ReconciliationPanel widget with RichLog + Syntax diff display, StatusBar extended with 4 new methods, styles.tcss updated (OCP — append only), tests proving panel behavior.
</objective>

<execution_context>
@/Users/jakeogden/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakeogden/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-flow-control-and-code-apply/04-CONTEXT.md
@.planning/phases/04-flow-control-and-code-apply/04-RESEARCH.md
@src/tui/widgets/status_bar.py
@src/tui/widgets/agent_pane.py
@src/tui/styles.tcss
@src/tui/content.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: ReconciliationPanel widget + StatusBar extensions</name>
  <files>src/tui/widgets/reconciliation_panel.py, src/tui/widgets/status_bar.py, tests/tui/test_reconciliation_panel.py</files>
  <action>
    Create src/tui/widgets/reconciliation_panel.py:

    ```python
    from textual.app import ComposeResult
    from textual.widget import Widget
    from textual.widgets import Label, RichLog
    from rich.syntax import Syntax

    class ReconciliationPanel(Widget):
        """Below-panes panel showing agent reconciliation discussion and unified diff.
        Hidden (display=False) until ReconciliationReady message arrives.
        """

        DEFAULT_CSS = """
        ReconciliationPanel {
            height: 15;
            border-top: solid $border;
            display: none;
        }
        ReconciliationPanel #recon-header {
            height: 1;
            background: $panel-darken-1;
            content-align: left middle;
            padding: 0 1;
        }
        ReconciliationPanel #recon-log {
            height: 1fr;
            padding: 0 1;
        }
        """

        def compose(self) -> ComposeResult:
            yield Label("Reconciliation", id="recon-header")
            yield RichLog(id="recon-log", highlight=True, markup=True)

        def show_reconciliation(self, discussion: str, diff_text: str) -> None:
            """Display reconciliation discussion and unified diff. Makes panel visible."""
            self.display = True
            log = self.query_one("#recon-log", RichLog)
            log.clear()
            if discussion:
                log.write(discussion)
            if diff_text.strip():
                log.write(Syntax(diff_text, "diff", theme="monokai", background_color="default"))
            else:
                log.write("[dim]No code differences detected — proposals are identical.[/dim]")

        def hide_panel(self) -> None:
            """Hide the panel and clear content (call on session reset)."""
            self.display = False
            self.query_one("#recon-log", RichLog).clear()
    ```

    Extend src/tui/widgets/status_bar.py by appending four new methods (do NOT modify existing methods — OCP compliance):

    ```python
    def show_debating(self, round_num: int, max_rounds: int) -> None:
        """Update text during live-debate rounds."""
        self.update(f"Debating — round {round_num}/{max_rounds}  •  Esc: end debate")

    def show_pick_winner(self) -> None:
        """Update text when pick-winner modal is showing."""
        self.update("Pick winner  •  arrow keys + Enter to select")

    def show_reconciling(self) -> None:
        """Update text during agent reconciliation."""
        self.update("Reconciling — agents comparing proposals...")

    def show_apply_confirm(self, file_count: int) -> None:
        """Update text during apply confirmation."""
        noun = "file" if file_count == 1 else "files"
        self.update(f"Ready to write {file_count} {noun}  •  y: apply  •  n: cancel")
    ```

    Create tests/tui/test_reconciliation_panel.py:
    - test_panel_hidden_by_default: mount ReconciliationPanel in test app, assert panel.display is False
    - test_show_reconciliation_makes_visible: call show_reconciliation("discuss", "diff"), assert panel.display is True
    - test_show_reconciliation_writes_discussion: RichLog contains discussion text after call
    - test_show_reconciliation_no_diff_shows_placeholder: empty diff_text -> "[dim]No code differences detected..." in log
    - test_hide_panel_hides_widget: show then hide, assert display is False

    Use MagicMock or Pilot as appropriate. RichLog in tests can use MagicMock pattern from Phase 2 (02-02 established this: MagicMock as RichLog stand-in to avoid async Pilot context). For display toggle tests, Pilot is simpler.
  </action>
  <verify>
    pytest tests/tui/test_reconciliation_panel.py -v
    # All 5 tests green

    python -c "from tui.widgets.reconciliation_panel import ReconciliationPanel; print('OK')"

    # Verify StatusBar has all 4 new methods
    python -c "from tui.widgets.status_bar import StatusBar; s = StatusBar.__dict__; [print(k) for k in ['show_debating','show_pick_winner','show_reconciling','show_apply_confirm'] if k in s]; print('all present')"
  </verify>
  <done>
    ReconciliationPanel hidden by default, visible after show_reconciliation(), with diff syntax highlighting.
    StatusBar has show_debating(round_num, max_rounds), show_pick_winner(), show_reconciling(), show_apply_confirm(file_count).
    All 5 panel tests pass. All prior tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Append Phase 4 CSS rules to styles.tcss</name>
  <files>src/tui/styles.tcss</files>
  <action>
    Read the current src/tui/styles.tcss. Append a clearly marked Phase 4 section at the end — do NOT modify any existing rules above it.

    Append:
    ```
    /* ─── Phase 4: Flow Control and Code Apply ──────────────────────────────── */

    FlowPickerScreen {
        align: left top;
        background: rgba(0, 0, 0, 0);
    }

    FlowPickerScreen #banner {
        width: 100%;
        height: auto;
        background: $panel-darken-2;
        padding: 0 1;
    }

    FlowPickerScreen #flow-options {
        width: 100%;
        height: auto;
        border: none;
        padding: 0;
    }

    WinnerPickerScreen {
        align: center middle;
        background: rgba(0, 0, 0, 0.5);
    }

    WinnerPickerScreen #winner-dialog {
        width: 60;
        height: auto;
        background: $surface;
        border: thick $background 80%;
        padding: 1 2;
    }

    ConfirmEndDebateScreen {
        align: center middle;
        background: rgba(0, 0, 0, 0.5);
    }

    ConfirmEndDebateScreen #confirm-dialog {
        width: 50;
        height: 5;
        background: $surface;
        border: thick $background 80%;
        padding: 1 2;
    }

    ApplyConfirmScreen {
        align: center middle;
        background: rgba(0, 0, 0, 0.5);
    }

    ApplyConfirmScreen #apply-dialog {
        width: 65;
        height: 7;
        background: $surface;
        border: thick $background 80%;
        padding: 1 2;
    }
    ```

    NOTE: ReconciliationPanel uses DEFAULT_CSS (defined in the class) so no additional CSS is needed in styles.tcss for it. The modal screens also have DEFAULT_CSS but the styles.tcss rules take precedence for app-level overrides, keeping styles organized in one place.
  </action>
  <verify>
    python -c "
    content = open('/Users/jakeogden/agent-bureau/src/tui/styles.tcss').read()
    assert 'Phase 4' in content
    assert 'FlowPickerScreen' in content
    assert 'WinnerPickerScreen' in content
    assert 'ConfirmEndDebateScreen' in content
    assert 'ApplyConfirmScreen' in content
    print('Phase 4 CSS rules present')
    "

    pytest --tb=short
    # Full suite still green (CSS changes don't break tests)
  </verify>
  <done>
    styles.tcss contains Phase 4 CSS section appended after Phase 3 rules. All existing CSS rules are unchanged. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
pytest tests/tui/test_reconciliation_panel.py -v
# 5 tests green

pytest --tb=short
# Full suite green (all prior tests passing)

python -c "from tui.widgets.reconciliation_panel import ReconciliationPanel; from tui.widgets.status_bar import StatusBar; print('OK')"
</verification>

<success_criteria>
- src/tui/widgets/reconciliation_panel.py exists with ReconciliationPanel widget (hidden by default, RichLog for discussion + Syntax diff)
- src/tui/widgets/status_bar.py has show_debating(round_num, max_rounds), show_pick_winner(), show_reconciling(), show_apply_confirm(file_count) — existing methods unchanged
- src/tui/styles.tcss has Phase 4 section appended (FlowPickerScreen, WinnerPickerScreen, ConfirmEndDebateScreen, ApplyConfirmScreen rules)
- 5 new tests pass in test_reconciliation_panel.py
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-flow-control-and-code-apply/04-04-SUMMARY.md`
</output>
