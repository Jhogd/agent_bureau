---
phase: 04-flow-control-and-code-apply
plan: "02"
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/tui/widgets/flow_picker_screen.py
  - src/tui/widgets/winner_picker_screen.py
  - src/tui/widgets/end_debate_screen.py
  - src/tui/widgets/apply_confirm_screen.py
  - tests/tui/test_modal_screens.py
autonomous: true
requirements:
  - ORCH-01
  - ORCH-05
  - APPLY-02
  - APPLY-03

must_haves:
  truths:
    - "FlowPickerScreen dismisses with 'pick-one' or 'live-debate' string when option is selected"
    - "WinnerPickerScreen dismisses with one of: 'agent-a', 'agent-b', 'keep-discussing', 'cancel'"
    - "ConfirmEndDebateScreen dismisses with True (end) or False (continue)"
    - "ApplyConfirmScreen dismisses with True (write) or False (reject)"
    - "FlowPickerScreen has Ctrl-C -> app.quit binding; all others have Escape -> reject/cancel"
    - "pick-one is pre-highlighted as default in FlowPickerScreen"
  artifacts:
    - path: "src/tui/widgets/flow_picker_screen.py"
      provides: "FlowPickerScreen(ModalScreen[str])"
      contains: "FlowPickerScreen"
    - path: "src/tui/widgets/winner_picker_screen.py"
      provides: "WinnerPickerScreen(ModalScreen[str])"
      contains: "WinnerPickerScreen"
    - path: "src/tui/widgets/end_debate_screen.py"
      provides: "ConfirmEndDebateScreen(ModalScreen[bool])"
      contains: "ConfirmEndDebateScreen"
    - path: "src/tui/widgets/apply_confirm_screen.py"
      provides: "ApplyConfirmScreen(ModalScreen[bool])"
      contains: "ApplyConfirmScreen"
    - path: "tests/tui/test_modal_screens.py"
      provides: "TDD tests for all four modal screens"
  key_links:
    - from: "src/tui/widgets/flow_picker_screen.py"
      to: "src/tui/app.py"
      via: "push_screen(FlowPickerScreen(), wait_for_dismiss=True)"
      pattern: "FlowPickerScreen"
    - from: "src/tui/widgets/apply_confirm_screen.py"
      to: "src/tui/app.py"
      via: "push_screen(ApplyConfirmScreen(), wait_for_dismiss=True)"
      pattern: "ApplyConfirmScreen"
---

<objective>
Build all four Phase 4 modal screens using TDD: FlowPickerScreen, WinnerPickerScreen, ConfirmEndDebateScreen, ApplyConfirmScreen.

Purpose: Modal screens are the primary user-interaction surfaces for flow control and code apply. Building them TDD-first proves their dismiss contracts before app wiring.
Output: Four new modal screen widget files, one test file proving dismiss behavior and CSS structure.
</objective>

<execution_context>
@/Users/jakeogden/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakeogden/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-flow-control-and-code-apply/04-CONTEXT.md
@.planning/phases/04-flow-control-and-code-apply/04-RESEARCH.md
@src/tui/widgets/quit_screen.py
</context>

<feature>
  <name>Four modal screens for Phase 4 flow control</name>
  <files>src/tui/widgets/flow_picker_screen.py, src/tui/widgets/winner_picker_screen.py, src/tui/widgets/end_debate_screen.py, src/tui/widgets/apply_confirm_screen.py, tests/tui/test_modal_screens.py</files>
  <behavior>
    FlowPickerScreen(ModalScreen[str]):
      - Slim top-banner (align: left top; background: transparent) — NOT a centered dialog
      - Contains a Vertical container "#banner" with a Label and OptionList "#flow-options"
      - OptionList has two options: id="pick-one" and id="live-debate"
      - on_mount: focuses OptionList, sets highlighted=0 (pick-one pre-highlighted)
      - on_option_list_option_selected: calls self.dismiss(event.option_id)
      - BINDINGS: Binding("ctrl+c", "app.quit", priority=True)
      - Option import: from textual.widgets._option_list import Option (NOT from textual.widgets)

    WinnerPickerScreen(ModalScreen[str]):
      - Four-option OptionList: id="agent-a", id="agent-b", id="keep-discussing", id="cancel"
      - Option labels: "Agent A wins", "Agent B wins", "Keep discussing", "Cancel (no changes)"
      - on_option_list_option_selected: self.dismiss(event.option_id)
      - BINDINGS: Binding("escape", "action_cancel", "Cancel")
      - action_cancel: self.dismiss("cancel")
      - Renders as an overlay (align: center middle; background: transparent)

    ConfirmEndDebateScreen(ModalScreen[bool]):
      - Shows Label: "End debate? [y/n]"
      - BINDINGS: Binding("y", "confirm"), Binding("n", "reject"), Binding("escape", "reject")
      - action_confirm: self.dismiss(True)
      - action_reject: self.dismiss(False)
      - Renders as a small centered dialog (width: 50, height: 5)

    ApplyConfirmScreen(ModalScreen[bool]):
      - Shows Label: "Apply changes? Press y to write files, n to cancel."
      - BINDINGS: Binding("y", "confirm", "Write files"), Binding("n", "reject", "Cancel"), Binding("escape", "reject", "Cancel")
      - action_confirm: self.dismiss(True)
      - action_reject: self.dismiss(False)
      - Renders as a centered dialog (width: 60, height: 7)

    Cases:
      FlowPickerScreen options -> ["pick-one", "live-debate"]
      WinnerPickerScreen options -> ["agent-a", "agent-b", "keep-discussing", "cancel"]
      ApplyConfirmScreen dismiss(True) -> True
      ApplyConfirmScreen dismiss(False) -> False
  </behavior>
  <implementation>
    RED: Write tests/tui/test_modal_screens.py using Textual Pilot:

      test_flow_picker_has_two_options: pilot mounts FlowPickerScreen, queries OptionList, asserts option_count == 2
      test_flow_picker_default_highlighted: pilot mounts FlowPickerScreen, queries OptionList, asserts highlighted == 0
      test_flow_picker_select_pick_one: pilot mounts a minimal App with FlowPickerScreen pushed, simulates Enter on highlighted item, captures dismiss value == "pick-one"
      test_flow_picker_select_live_debate: pilot selects second option (arrow down + Enter), dismiss value == "live-debate"
      test_winner_picker_has_four_options: OptionList.option_count == 4
      test_confirm_end_debate_y_returns_true: pilot presses "y", dismiss value is True
      test_confirm_end_debate_n_returns_false: pilot presses "n", dismiss value is False
      test_apply_confirm_y_returns_true: pilot presses "y", dismiss value is True
      test_apply_confirm_n_returns_false: pilot presses "n", dismiss value is False
      test_apply_confirm_escape_returns_false: pilot presses "escape", dismiss value is False

    NOTE: Pilot tests for ModalScreen work by creating a minimal wrapper App class (same pattern as Phase 2 quit_screen tests). Check existing tests/tui/test_quit_screen.py for exact pattern.

    Run tests — MUST fail (RED). Commit: test(04-02): add failing tests for Phase 4 modal screens

    GREEN: Create all four widget files. Use research patterns exactly:
      - Import Option from textual.widgets._option_list (not textual.widgets — Pitfall 2)
      - FlowPickerScreen: on_mount focuses OptionList, sets highlighted=0
      - Use DEFAULT_CSS in each screen (CSS embedded in class — same pattern as QuitScreen)
      - ConfirmEndDebateScreen and ApplyConfirmScreen: use Binding y/n/escape only (no OptionList)
      - Each file is self-contained: all imports at top of file, no circular imports

    Run tests — MUST pass (GREEN). Commit: feat(04-02): implement four Phase 4 modal screens

    REFACTOR: Add module-level docstrings explaining dismiss contract for each screen. No logic changes.
    Commit: refactor(04-02): add docstrings and clarify dismiss contracts
  </implementation>
</feature>

<verification>
# Check existing quit_screen test pattern first
cat /Users/jakeogden/agent-bureau/tests/tui/test_quit_screen.py

pytest tests/tui/test_modal_screens.py -v
# All 10 tests green

pytest --tb=short
# Full suite green (0 regressions)

python -c "from tui.widgets.flow_picker_screen import FlowPickerScreen; from tui.widgets.winner_picker_screen import WinnerPickerScreen; from tui.widgets.end_debate_screen import ConfirmEndDebateScreen; from tui.widgets.apply_confirm_screen import ApplyConfirmScreen; print('imports OK')"
</verification>

<success_criteria>
- Four widget files exist in src/tui/widgets/
- tests/tui/test_modal_screens.py has 10 tests, all passing
- FlowPickerScreen: top-banner layout, two options, pick-one pre-highlighted, Ctrl-C quits app
- WinnerPickerScreen: four-option OptionList, Escape dismisses with "cancel"
- ConfirmEndDebateScreen: y=True, n/Escape=False
- ApplyConfirmScreen: y=True, n/Escape=False
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-flow-control-and-code-apply/04-02-SUMMARY.md`
</output>
