---
phase: 04-flow-control-and-code-apply
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/tui/session.py
  - src/tui/messages.py
  - tests/tui/test_session.py
  - tests/tui/test_messages.py
autonomous: true
requirements:
  - ORCH-01
  - ORCH-04
  - ORCH-05
  - APPLY-01
  - APPLY-02
  - APPLY-03

must_haves:
  truths:
    - "SessionState enum contains Phase 4 states: FLOW_PICK, DEBATING, PICK_WINNER, RECONCILING, CONFIRMING_APPLY"
    - "RoundBoundary, DebateEnded, ReconciliationReady, and ApplyResult messages are importable from tui.messages"
    - "All Phase 3 states (IDLE, STREAMING, CLASSIFYING, DONE) remain unchanged"
  artifacts:
    - path: "src/tui/session.py"
      provides: "Extended SessionState enum with Phase 4 states"
      contains: "FLOW_PICK"
    - path: "src/tui/messages.py"
      provides: "Phase 4 message types"
      contains: "RoundBoundary"
    - path: "tests/tui/test_session.py"
      provides: "TDD tests for Phase 4 SessionState values"
    - path: "tests/tui/test_messages.py"
      provides: "TDD tests for Phase 4 message construction"
  key_links:
    - from: "src/tui/session.py"
      to: "src/tui/app.py"
      via: "import SessionState"
      pattern: "FLOW_PICK|DEBATING|PICK_WINNER|RECONCILING|CONFIRMING_APPLY"
    - from: "src/tui/messages.py"
      to: "src/tui/app.py"
      via: "post_message(RoundBoundary(...))"
      pattern: "RoundBoundary|DebateEnded|ReconciliationReady|ApplyResult"
---

<objective>
Extend SessionState and messages.py with Phase 4 types using strict TDD.

Purpose: Provide the typed foundation that all Phase 4 code (app wiring, modal screens, debate loop) depends on. This is pure Python logic — no Textual UI involved — making it ideal for fast, deterministic TDD.
Output: Extended session.py (5 Phase 4 states added), extended messages.py (4 new dataclass messages), test files proving both.
</objective>

<execution_context>
@/Users/jakeogden/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakeogden/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-flow-control-and-code-apply/04-CONTEXT.md
@.planning/phases/04-flow-control-and-code-apply/04-RESEARCH.md
@src/tui/session.py
@src/tui/messages.py
</context>

<feature>
  <name>Phase 4 SessionState states and message types</name>
  <files>src/tui/session.py, src/tui/messages.py, tests/tui/test_session.py, tests/tui/test_messages.py</files>
  <behavior>
    SessionState must contain five Phase 4 states appended after existing DONE state:
      FLOW_PICK    — waiting for user to select pick-one or live-debate
      DEBATING     — live-debate rounds in progress
      PICK_WINNER  — waiting for user to select which agent won
      RECONCILING  — agents producing reconciliation + diff
      CONFIRMING_APPLY — showing diff, waiting for user y/n

    All existing states (IDLE, STREAMING, CLASSIFYING, DONE) must remain identical. No renaming, no reordering, no removal.

    Four new dataclass messages must be added to messages.py:
      RoundBoundary(round_num: int) — triggers divider line in both panes
      DebateEnded() — signals debate rounds complete, triggers pick-winner transition
      ReconciliationReady(discussion_text: str, diff_text: str, agreed_code: str, language: str) — reconciliation ready for panel display
      ApplyResult(confirmed: bool, files_written: list[str]) — user confirmed or rejected write

    All four message classes must use @dataclass decorator (matching Phase 3 pattern: TokenReceived, AgentFinished, ClassificationDone).

    Cases:
      SessionState.FLOW_PICK in SessionState   -> True
      SessionState.DEBATING in SessionState    -> True
      SessionState.IDLE in SessionState        -> True  (unchanged)
      RoundBoundary(round_num=2).round_num     -> 2
      DebateEnded().NAMESPACE                  -> "DebateEnded"
      ReconciliationReady(discussion_text="discuss", diff_text="diff", agreed_code="code", language="python") — all fields accessible
      ApplyResult(confirmed=True, files_written=["src/foo.py"]).files_written -> ["src/foo.py"]
  </behavior>
  <implementation>
    RED: Write tests/tui/test_session.py first:
      - test that all 9 SessionState members exist (IDLE, STREAMING, CLASSIFYING, DONE, FLOW_PICK, DEBATING, PICK_WINNER, RECONCILING, CONFIRMING_APPLY)
      - test that SessionState members are distinct (no duplicates)
      - test that IDLE.value != FLOW_PICK.value (auto() assigns unique ints)

    Write tests/tui/test_messages.py:
      - test_round_boundary_has_round_num: RoundBoundary(round_num=1).round_num == 1
      - test_debate_ended_is_message: isinstance(DebateEnded(), Message)
      - test_reconciliation_ready_fields: all four fields accessible with correct types
      - test_apply_result_confirmed: ApplyResult(confirmed=True, files_written=[]).confirmed is True
      - test_apply_result_files_written: ApplyResult(confirmed=False, files_written=["a.py"]).files_written == ["a.py"]

    Run tests — they MUST fail (RED). Commit: test(04-01): add failing tests for Phase 4 session states and messages

    GREEN: Extend src/tui/session.py — append Phase 4 states after DONE using auto(). Do NOT modify any existing state. Add docstring explaining Phase 4 states.

    Extend src/tui/messages.py — add four @dataclass Message subclasses after ClassificationDone. Import BridgeEvent is already present; no new imports needed for the new messages (list[str] uses built-in).

    Run tests — they MUST pass (GREEN). Commit: feat(04-01): extend SessionState and messages with Phase 4 types

    REFACTOR: Review for clarity — ensure Phase 4 states have inline comments (e.g., "# Phase 4 additions"). No logic changes needed. Commit: refactor(04-01): add inline comments to Phase 4 states and messages
  </implementation>
</feature>

<verification>
pytest tests/tui/test_session.py tests/tui/test_messages.py -v
# All tests green

pytest --tb=short
# Full suite green (77+ tests, 0 failures)
</verification>

<success_criteria>
- tests/tui/test_session.py exists with tests for all 9 SessionState members
- tests/tui/test_messages.py exists with tests for all 4 new message types
- All new tests pass; all prior tests continue to pass
- src/tui/session.py contains FLOW_PICK, DEBATING, PICK_WINNER, RECONCILING, CONFIRMING_APPLY
- src/tui/messages.py contains RoundBoundary, DebateEnded, ReconciliationReady, ApplyResult as @dataclass Message subclasses
</success_criteria>

<output>
After completion, create `.planning/phases/04-flow-control-and-code-apply/04-01-SUMMARY.md`
</output>
