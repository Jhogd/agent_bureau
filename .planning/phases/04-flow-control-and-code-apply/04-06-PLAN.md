---
phase: 04-flow-control-and-code-apply
plan: "06"
type: execute
wave: 3
depends_on:
  - 04-05
files_modified: []
autonomous: false
requirements:
  - ORCH-01
  - ORCH-04
  - ORCH-05
  - APPLY-01
  - APPLY-02
  - APPLY-03

must_haves:
  truths:
    - "Flow-picker banner appears at the top after prompt submission"
    - "pick-one is pre-highlighted; arrow down selects live-debate"
    - "Both agent panes stream tokens after flow is chosen"
    - "In live-debate, round divider lines appear between rounds"
    - "Esc during debate shows 'End debate? [y/n]' prompt"
    - "Winner picker shows four options after streaming completes"
    - "ReconciliationPanel appears below panes after winner is selected"
    - "Apply confirm prompt shows before any file is written"
    - "Ctrl-C from the flow picker exits the app cleanly"
    - "Cancelling at winner picker shows 'Cancelled — no files written' in status bar"
  artifacts: []
  key_links: []
---

<objective>
Human visual verification of all Phase 4 flow control and code apply behaviors.

Purpose: Automated tests prove message routing and state transitions. This checkpoint confirms the visual and interactive behaviors are correct end-to-end — the flow picker banner looks right, round dividers appear, ReconciliationPanel renders, and the y/n confirmation gate works.
Output: Human-verified Phase 4 TUI flows.
</objective>

<execution_context>
@/Users/jakeogden/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakeogden/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-flow-control-and-code-apply/04-CONTEXT.md
@.planning/phases/04-flow-control-and-code-apply/04-05-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Visual verification of Phase 4 flow control and code apply</name>
  <action>
    Run automated test suite to confirm all tests pass before visual verification:

    ```bash
    cd /Users/jakeogden/agent-bureau && source .venv/bin/activate && pytest --tb=short
    ```

    Then launch the TUI OUTSIDE Claude Code (CLAUDECODE env var blocks claude CLI subprocess). Open a new terminal window:

    ```bash
    cd /Users/jakeogden/agent-bureau
    source .venv/bin/activate
    python -m tui.app
    ```

    Work through the visual checklist below.
  </action>
  <verify>
    Visual checklist (check each item):

    1. FLOW PICKER
       - After typing any prompt and pressing Enter, a banner appears at the top of the terminal
       - Banner shows two options: "Pick one" and "Live debate"
       - "Pick one" is highlighted (pre-selected) — no extra keypress needed
       - Arrow down moves highlight to "Live debate"
       - Arrow up moves highlight back to "Pick one"
       - Pressing Enter selects the highlighted option
       - Ctrl-C from the flow picker exits the app (no forced flow choice, clean exit)

    2. PICK-ONE FLOW
       - After selecting "Pick one" and pressing Enter, both agent panes start streaming
       - StatusBar shows "streaming" state during streaming
       - After both agents finish, WinnerPickerScreen appears
       - Four options visible: Agent A wins, Agent B wins, Keep discussing, Cancel (no changes)
       - Arrow keys navigate options; Enter selects

    3. WINNER PICKER
       - Selecting "Agent A wins" triggers reconciliation (StatusBar: "Reconciling — agents comparing proposals...")
       - ReconciliationPanel appears below the agent panes
       - Panel shows plain-text discussion from the reconciliation agent
       - Panel shows a unified diff (if code proposals were found) with syntax highlighting
       - If no code was found in agent output, panel shows "No code differences detected"
       - Selecting "Cancel (no changes)" shows "Cancelled — no files written" in StatusBar; no ReconciliationPanel

    4. APPLY CONFIRM
       - After reconciliation, ApplyConfirmScreen appears
       - Prompt: "Apply changes? Press y to write files, n to cancel."
       - Pressing n: StatusBar shows "Cancelled — no files written"; app returns to IDLE
       - Pressing y: StatusBar shows "Applied — wrote N file(s)" (or "no files detected" if no filename found)
       - After either choice: prompt input re-enabled, new prompt can be submitted

    5. LIVE-DEBATE FLOW (if claude CLI is available outside CLAUDECODE)
       - Select "Live debate" from flow picker
       - "── Round 1 ──" divider appears in both panes before each round's streaming
       - StatusBar shows "Debating — round 1/3  •  Esc: end debate"
       - Pressing Esc shows: "End debate? [y/n]"
       - Pressing y ends debate after current round completes, moves to WinnerPickerScreen
       - Pressing n continues debate rounds

    6. EDGE CASES
       - Ctrl-L clears panes and hides ReconciliationPanel; new prompt can be submitted
       - Ctrl-C at any point shows QuitScreen or exits cleanly (per Phase 2 behavior)
  </verify>
  <done>
    Human types "approved" confirming:
    - All automated tests pass
    - Flow picker appears as slim banner with pick-one pre-highlighted
    - Both pick-one and live-debate flows work end-to-end
    - ReconciliationPanel shows discussion + diff after winner selection
    - y/n gate works: y applies changes, n cancels with clear status message
  </done>
</task>

</tasks>

<verification>
Human visual approval of all flow control and code apply behaviors.
pytest --tb=short passes (all tests green).
</verification>

<success_criteria>
- All automated tests pass (full pytest suite green)
- Flow picker appears as slim banner with pick-one pre-highlighted
- Both agent flows (pick-one, live-debate) work end-to-end
- ReconciliationPanel shows discussion + diff after winner selection
- y/n gate works: y writes files, n cancels with clear status message
- Human types "approved" to confirm
</success_criteria>

<output>
After completion, create `.planning/phases/04-flow-control-and-code-apply/04-06-SUMMARY.md`
</output>
