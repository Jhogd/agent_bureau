---
phase: 03-live-streaming-integration
plan: "02"
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/tui/widgets/agent_pane.py
  - tests/tui/test_agent_pane.py
autonomous: true
requirements: [TUI-03]

must_haves:
  truths:
    - "AgentPane.write_token() appends a single ANSI-decoded line to the RichLog without using write_content_to_pane()"
    - "AgentPane.line_count property returns the number of lines written via write_token()"
    - "AgentPane.clear() resets the pane to its initial placeholder state"
    - "AgentPane can receive a disagreement highlight CSS class and remove it"
  artifacts:
    - path: "src/tui/widgets/agent_pane.py"
      provides: "Extended AgentPane with write_token(), line_count, clear(), set_disagreement_highlight()"
      exports: ["AgentPane"]
    - path: "tests/tui/test_agent_pane.py"
      provides: "TDD suite for new AgentPane methods (extending existing 5-test suite)"
  key_links:
    - from: "src/tui/widgets/agent_pane.py"
      to: "rich.ansi.AnsiDecoder"
      via: "write_token() decodes ANSI before writing to RichLog"
      pattern: "AnsiDecoder"
    - from: "src/tui/widgets/agent_pane.py"
      to: "tui.content.SCROLLBACK_LIMIT"
      via: "clear() triggers when line_count approaches limit"
      pattern: "SCROLLBACK_LIMIT"
---

<objective>
TDD extension of AgentPane with the methods needed for live streaming: a per-token write path with ANSI decoding, a line counter for the status bar, a clear method for scrollback reset, and a disagreement highlight toggle for classification results.

Purpose: The existing `write_content()` method processes multi-line blocks with fenced code parsing — it is not suitable for per-token streaming. A separate `write_token()` method is needed (research pitfall: do NOT reuse `write_content()` for streaming). These methods have clear I/O contracts, making them ideal TDD candidates.

Output: Extended `src/tui/widgets/agent_pane.py` with 4 new methods/properties, proven by an extended test suite.
</objective>

<execution_context>
@/Users/jakeogden/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakeogden/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-live-streaming-integration/03-RESEARCH.md
@src/tui/widgets/agent_pane.py
@src/tui/content.py
@tests/tui/test_agent_pane.py
</context>

<tasks>

<task type="tdd">
  <name>Task 1: RED — Failing tests for AgentPane streaming extensions</name>
  <files>
    tests/tui/test_agent_pane.py
  </files>
  <action>
Read the existing `tests/tui/test_agent_pane.py` first. Append new failing tests to the existing file. Do NOT modify existing tests.

Add the following new test cases (using the existing `PaneTestApp` pattern where a host App wraps AgentPane in a Pilot harness):

```python
# NEW TESTS — append below existing tests

@pytest.mark.asyncio
async def test_write_token_appends_to_richlog():
    """write_token() writes a single line to the RichLog and reveals it."""
    app = PaneTestApp()
    async with app.run_test() as pilot:
        pane = app.query_one("#pane-left", AgentPane)
        pane.write_token("hello world")
        log = pane.query_one("#content", RichLog)
        assert log.display is True

@pytest.mark.asyncio
async def test_write_token_increments_line_count():
    """line_count tracks the number of write_token() calls."""
    app = PaneTestApp()
    async with app.run_test() as pilot:
        pane = app.query_one("#pane-left", AgentPane)
        assert pane.line_count == 0
        pane.write_token("line 1")
        assert pane.line_count == 1
        pane.write_token("line 2")
        assert pane.line_count == 2

@pytest.mark.asyncio
async def test_write_token_decodes_ansi():
    """write_token() accepts ANSI escape sequences without raising."""
    app = PaneTestApp()
    async with app.run_test() as pilot:
        pane = app.query_one("#pane-left", AgentPane)
        # Should not raise; AnsiDecoder handles the escape sequence
        pane.write_token("\x1b[32mgreen text\x1b[0m")
        assert pane.line_count == 1

@pytest.mark.asyncio
async def test_clear_resets_pane():
    """clear() resets line_count, hides RichLog, shows placeholder."""
    app = PaneTestApp()
    async with app.run_test() as pilot:
        pane = app.query_one("#pane-left", AgentPane)
        pane.write_token("some content")
        assert pane.line_count == 1
        pane.clear()
        assert pane.line_count == 0
        log = pane.query_one("#content", RichLog)
        placeholder = pane.query_one("#placeholder", Label)
        assert log.display is False
        assert placeholder.display is True

@pytest.mark.asyncio
async def test_disagreement_highlight_added_and_removed():
    """set_disagreement_highlight(True/False) adds/removes CSS class."""
    app = PaneTestApp()
    async with app.run_test() as pilot:
        pane = app.query_one("#pane-left", AgentPane)
        pane.set_disagreement_highlight(True)
        assert pane.has_class("disagreement")
        pane.set_disagreement_highlight(False)
        assert not pane.has_class("disagreement")
```

Run: `.venv/bin/pytest tests/tui/test_agent_pane.py -v`
New tests must fail (AttributeError or similar — `write_token`, `line_count`, `clear`, `set_disagreement_highlight` don't exist yet).
Commit: `test(03-02): add failing tests for AgentPane streaming extensions`

CRITICAL: Do NOT create tests/tui/__init__.py.
  </action>
  <verify>
`.venv/bin/pytest tests/tui/test_agent_pane.py -v` shows the 5 original tests passing and the 5 new tests failing with AttributeError or similar.
  </verify>
  <done>5 new tests exist in test_agent_pane.py and fail. 5 existing tests still pass.</done>
</task>

<task type="tdd">
  <name>Task 2: GREEN — Implement write_token(), line_count, clear(), set_disagreement_highlight() on AgentPane</name>
  <files>
    src/tui/widgets/agent_pane.py
  </files>
  <action>
Read the existing `src/tui/widgets/agent_pane.py` first. Add the following to the class.

**Imports to add at the top of the file:**
```python
from rich.ansi import AnsiDecoder
from rich.text import Text
```

**Add as a class-level attribute** (after `can_focus = True`):
```python
_ansi_decoder = AnsiDecoder()
```

**Add to `__init__`** (after `self._has_content = False`):
```python
self._line_count: int = 0
```

**Add these methods** (after `write_content()`):

```python
@property
def line_count(self) -> int:
    """Number of lines written via write_token()."""
    return self._line_count

def write_token(self, line: str) -> None:
    """Write a single streamed token line to the RichLog.

    Decodes ANSI escape sequences before writing so Rich does not
    interpret them as markup. Increments the internal line counter.
    """
    log = self.query_one("#content", RichLog)
    if not self._has_content:
        self._has_content = True
        self.query_one("#placeholder", Label).display = False
        log.display = True
    # Use next() with a fallback so an empty line doesn't crash.
    rich_text = next(self._ansi_decoder.decode(line), Text(line))
    log.write(rich_text)
    self._line_count += 1

def clear(self) -> None:
    """Reset the pane to its empty state (placeholder visible, RichLog cleared)."""
    log = self.query_one("#content", RichLog)
    log.clear()
    log.display = False
    self.query_one("#placeholder", Label).display = True
    self._has_content = False
    self._line_count = 0

def set_disagreement_highlight(self, active: bool) -> None:
    """Add or remove the 'disagreement' CSS class on this pane.

    When active=True, the pane header changes color (per styles.tcss).
    """
    if active:
        self.add_class("disagreement")
    else:
        self.remove_class("disagreement")
```

Run: `.venv/bin/pytest tests/tui/test_agent_pane.py -v`
All 10 tests must pass.
Run full suite: `.venv/bin/pytest` — no regressions.
Commit: `feat(03-02): add write_token, line_count, clear, set_disagreement_highlight to AgentPane`
  </action>
  <verify>
`.venv/bin/pytest tests/tui/test_agent_pane.py -v` exits 0 with all 10 tests passing. `.venv/bin/pytest` exits 0 with no regressions.
  </verify>
  <done>AgentPane has write_token(), line_count property, clear(), set_disagreement_highlight(). All 10 agent_pane tests pass. Full suite passes.</done>
</task>

</tasks>

<verification>
- `src/tui/widgets/agent_pane.py` has `write_token()`, `line_count` property, `clear()`, and `set_disagreement_highlight()`
- `rich.ansi.AnsiDecoder` is imported and used in `write_token()`
- 10 tests in test_agent_pane.py pass (5 original + 5 new)
- Full pytest suite passes with no regressions
</verification>

<success_criteria>
`AgentPane.write_token("\x1b[32mhello\x1b[0m")` executes without error. `AgentPane.line_count` returns the count of tokens written. `AgentPane.clear()` resets the pane. All 10 tests green.
</success_criteria>

<output>
After completion, create `.planning/phases/03-live-streaming-integration/03-02-SUMMARY.md` following the summary template.
</output>
