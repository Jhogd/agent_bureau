---
phase: 03-live-streaming-integration
plan: "04"
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/tui/app.py
  - tests/tui/test_app.py
autonomous: false
requirements: [TUI-03, TUI-09, ORCH-02, ORCH-03, ORCH-06]

must_haves:
  truths:
    - "User sees a status bar at the top showing keyboard hints before any prompt is submitted"
    - "User can type a prompt in the bottom input bar and press Enter to submit"
    - "Input is disabled/grayed-out immediately on submission; both agents begin streaming simultaneously"
    - "Each agent's tokens appear in the correct labeled pane as they arrive (token-by-token)"
    - "Status bar updates with per-agent streaming state and line counts during streaming"
    - "After both agents finish, the pane content persists; next prompt appends with a visual separator"
    - "After classification, the status bar shows agreement or disagreement type; disagreeing pane headers highlight"
    - "Input is re-enabled and auto-focused after classification completes"
    - "User cannot submit a new prompt while agents are streaming (state machine gate)"
    - "Agent errors append a visible error message to the pane (e.g., '[error: agent exited with code 1]')"
    - "Ctrl-L clears both panes simultaneously and resets to IDLE"
  artifacts:
    - path: "src/tui/app.py"
      provides: "AgentBureauApp fully wired with bridge worker, message handlers, state machine, classification"
      exports: ["AgentBureauApp", "main"]
    - path: "tests/tui/test_app.py"
      provides: "Integration tests for streaming, state gating, classification routing, error display, clear"
  key_links:
    - from: "src/tui/app.py"
      to: "tui.bridge._stream_pty / _stream_pipe"
      via: "_run_session worker uses asyncio.Queue and create_task for both agents concurrently"
      pattern: "_stream_pty|_stream_pipe"
    - from: "src/tui/app.py"
      to: "tui.messages.TokenReceived"
      via: "_run_session calls post_message(TokenReceived(...)) for each queue event of type token"
      pattern: "post_message.*TokenReceived"
    - from: "src/tui/app.py"
      to: "tui.session.SessionState"
      via: "session_state reactive attribute drives Input.disabled and status bar text"
      pattern: "session_state"
    - from: "src/tui/app.py"
      to: "disagree_v1.classifier.classify_disagreements"
      via: "_run_classification() called after both AgentFinished events; result posted as ClassificationDone"
      pattern: "classify_disagreements"
    - from: "src/tui/app.py"
      to: "src/tui/widgets/agent_pane.py"
      via: "on_token_received routes TokenReceived to pane.write_token(); on_classification_done calls pane.set_disagreement_highlight()"
      pattern: "write_token|set_disagreement_highlight"
---

<objective>
Rewrite AgentBureauApp to wire the async bridge (Phase 1) to the TUI (Phase 2+03-02/03-03). Adds prompt submission, the streaming worker, Textual message routing, state machine gating, classification, and a human visual checkpoint to confirm the full streaming flow works end-to-end.

Purpose: This is the integration plan — all prior Phase 3 plans built the pieces; this plan assembles them. The FakeAgentRunner pattern from Phase 1 tests will be used for the Pilot integration tests (cannot use real `claude`/`codex` inside Claude Code per STATE.md blocker).

Output: A fully functional live-streaming TUI with tests and human sign-off.
</objective>

<execution_context>
@/Users/jakeogden/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakeogden/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-live-streaming-integration/03-RESEARCH.md
@.planning/phases/03-live-streaming-integration/03-01-SUMMARY.md
@.planning/phases/03-live-streaming-integration/03-02-SUMMARY.md
@.planning/phases/03-live-streaming-integration/03-03-SUMMARY.md
@src/tui/app.py
@src/tui/bridge.py
@src/tui/event_bus.py
@src/tui/messages.py
@src/tui/session.py
@src/tui/widgets/agent_pane.py
@src/tui/widgets/status_bar.py
@src/tui/widgets/prompt_bar.py
@tests/tui/test_app.py
@tests/tui/test_bridge.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite AgentBureauApp with bridge wiring and integration tests</name>
  <files>
    src/tui/app.py
    tests/tui/test_app.py
  </files>
  <action>
Read `src/tui/app.py`, `tests/tui/test_app.py`, `tests/tui/test_bridge.py`, and all Phase 3 SUMMARY files before writing.

**Rewrite src/tui/app.py** with the following behavior:

Layout (top to bottom):
1. `StatusBar` (id="status-bar") — docked top via CSS, always visible
2. `Horizontal` container with AgentPane x 2 + divider — fills remaining height
3. `PromptBar` (id="prompt-bar") containing `Input(id="prompt-input")` — docked bottom

Key bindings: add `ctrl+l` for clear (in addition to existing left/right/q/ctrl+c).

Session state machine:
- `session_state: reactive[SessionState] = reactive(SessionState.IDLE)`
- `watch_session_state()` toggles `self.query_one("#prompt-input", Input).disabled` based on state in (STREAMING, CLASSIFYING)

Internal state tracking:
- `self._terminal_events: dict[str, BridgeEvent] = {}` — resets on each new prompt
- `self._agent_line_counts: dict[str, int] = {"claude": 0, "codex": 0}` — resets on new prompt

**on_input_submitted** handler:
```python
def on_input_submitted(self, event: Input.Submitted) -> None:
    prompt = event.value.strip()
    if not prompt or self.session_state != SessionState.IDLE:
        return
    event.input.clear()
    self._start_session(prompt)
```

**_start_session** method:
- Reset `_terminal_events`, `_agent_line_counts`
- Write run separator to both panes: `pane.write_token("\u2500" * 60)` (U+2500 BOX DRAWINGS LIGHT HORIZONTAL, 60 chars)
- Set `session_state = SessionState.STREAMING`
- Call `self.run_worker(self._run_session(prompt), exclusive=True, exit_on_error=False, name="bridge-session")`

**_run_session(prompt)** async worker:
- Import `_stream_pty`, `_stream_pipe`, `_pty_available`, `CLAUDE`, `CODEX` from `tui.bridge`
- Create shared `asyncio.Queue()`, launch two `asyncio.create_task()` calls (one per agent)
- Loop until 2 terminal events received, posting `TokenReceived` or `AgentFinished` via `self.post_message()`
- Do NOT call widget methods directly from within this worker — always use `post_message()`
- After loop: `await asyncio.gather(task_a, task_b)`

**on_token_received** handler:
- Route to correct pane by agent name ("claude" to "#pane-left", "codex" to "#pane-right")
- Call `pane.write_token(message.text)`
- Increment `_agent_line_counts[message.agent]`
- Call status bar `show_streaming()` with current counts
- Check scrollback: if either pane's line_count >= SCROLLBACK_LIMIT, call `action_clear_panes()`

**on_agent_finished** handler:
- Store terminal event in `_terminal_events[message.agent]`
- If the event is AgentError or AgentTimeout: append visible error to pane
  - AgentError: `pane.write_token(f"[error: agent exited with code {event.exit_code}]")`
  - AgentTimeout: `pane.write_token("[error: agent timed out]")`
- Call status bar `show_done()` with current counts
- If `len(_terminal_events) == 2`: set `session_state = CLASSIFYING`, call `_run_classification()`

**_run_classification** method:
- Collect full_texts from AgentDone events only (skip AgentError/AgentTimeout)
- Attempt to parse via `CommandJsonAdapter._parse_payload()` and `_validate_payload()`; wrap in try/except — any failure sets `disagreements = []`
- If two AgentResponse objects successfully built: call `classify_disagreements(a, b)`
- Call `self.post_message(ClassificationDone(disagreements=disagreements, full_texts=texts))`

**on_classification_done** handler:
- Set `session_state = SessionState.DONE`
- Call `status_bar.show_classification(counts, message.disagreements)`
- Call `pane.set_disagreement_highlight(bool(message.disagreements))` on both panes
- Call `self.query_one("#prompt-input", Input).focus()`
- Set `session_state = SessionState.IDLE`

**action_clear_panes** method (Ctrl-L binding):
- Call `pane.clear()` on both panes
- Reset `_agent_line_counts = {"claude": 0, "codex": 0}`
- Call `status_bar.show_hints()`

**Remove the Phase 2 placeholder logic** from `on_mount()`: no more `write_content(_PLACEHOLDER_CONTENT)` calls. `on_mount()` should only focus pane-left.

**Rewrite tests/tui/test_app.py** (keep the 13 existing tests that still apply; update any that break due to layout changes):

New integration tests using post_message injection (no real subprocesses needed):

Use `app.post_message(TokenReceived(...))` and `await pilot.pause()` to drive the message pump in tests. Write explicit test functions for:

1. `test_token_received_routes_to_correct_pane` — post TokenReceived(agent="claude", text="hello"), assert pane-left has content
2. `test_agent_finished_with_error_shows_error_in_pane` — post AgentFinished with AgentError event, assert error text in pane
3. `test_state_machine_disables_input_while_streaming` — set app.session_state = STREAMING, assert Input.disabled is True
4. `test_classification_done_sets_disagreement_highlight` — post ClassificationDone with non-empty disagreements, assert both panes have "disagreement" class
5. `test_classification_done_without_disagreements_no_highlight` — post ClassificationDone with [], assert panes do not have "disagreement" class
6. `test_ctrl_l_clears_both_panes` — write tokens to both panes, press ctrl+l, assert both panes are cleared

Run: `.venv/bin/pytest tests/tui/test_app.py -v` — all tests must pass.
Run full suite: `.venv/bin/pytest` — no regressions.
Commit: `feat(03-04): wire AgentBureauApp with bridge, streaming worker, state machine, and classification`

IMPORTANT PITFALLS (from RESEARCH.md):
- Do NOT call `write_token()` or any widget method directly from `_run_session` — always use `post_message()`
- Do NOT use `call_from_thread()` — `_run_session` is an async worker (same event loop thread)
- Do NOT use `run_bridge()` — it collects all events after completion, blocking real-time display
- Do NOT classify before both terminal events arrive — gate strictly on `len(_terminal_events) == 2`
  </action>
  <verify>
`.venv/bin/pytest tests/tui/test_app.py -v` exits 0. `.venv/bin/pytest` exits 0 with no regressions. `src/tui/app.py` contains `_run_session`, `on_token_received`, `on_agent_finished`, `on_classification_done`, `action_clear_panes`.
  </verify>
  <done>AgentBureauApp fully wired. All new integration tests pass. Full suite passes. Committed.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of live streaming TUI</name>
  <action>
Run the completed TUI in a real terminal outside Claude Code (the `claude` CLI is blocked by the CLAUDECODE env var inside this session). Verify the initial layout and as much streaming behavior as possible.

Open a new terminal tab (not inside Claude Code), then run:

```bash
cd /Users/jakeogden/agent-bureau
source .venv/bin/activate
python -m tui.app
```

Walk through the verification checks below. Report any visual issues so they can be fixed before Phase 4.
  </action>
  <verify>
Confirm each of the following (pass/fail per item):

1. STATUS BAR: Status bar visible at the top, showing keyboard hints before any input
2. PROMPT BAR: Prompt input bar visible at the bottom, with placeholder text
3. PROMPT INPUT: Typing characters appears in the input bar; cursor visible
4. AGENT PANES: Both panes show agent names ("claude", "codex") in headers; placeholders visible
5. STREAMING GATE: After submitting a prompt (Enter), input bar is disabled/grayed while agents stream
6. TOKEN DISPLAY: Tokens appear in both panes as they arrive (not all at once at the end)
7. STATUS UPDATES: Status bar shows per-agent streaming counts during run
8. COMPLETION: Status bar updates when both agents are done; input re-enabled
9. CLASSIFICATION: Status bar shows "agents agree" or "disagreement: [type]" after classification
10. DISAGREEMENT HIGHLIGHT: Pane headers change color if disagreement detected
11. SEPARATOR: A visual separator appears in both panes between successive prompt runs
12. CTRL-L: Pressing Ctrl-L clears both panes simultaneously; status bar resets to hints

Items 1-5 are verifiable immediately on launch. Items 6-12 require agents to be running outside Claude Code.
  </verify>
  <done>User types "approved" confirming items 1-5 pass (minimum), or describes any issues. Items 6-12 confirmed on next manual run outside Claude Code if needed.</done>
</task>

</tasks>

<verification>
- `src/tui/app.py` imports and uses: `SessionState`, `TokenReceived`, `AgentFinished`, `ClassificationDone`, `StatusBar`, `PromptBar`
- `_run_session` uses `post_message()` only — never calls widget methods directly
- `watch_session_state` toggles `Input.disabled` based on state
- Classification runs only after both terminal events received
- Full pytest suite passes
- Human visual checkpoint approved
</verification>

<success_criteria>
TUI launches with status bar and prompt bar visible. Input disables on submit. Tokens routed correctly per tests. Classification result appears. All tests green. Human sign-off on initial layout (items 1-5 minimum).
</success_criteria>

<output>
After completion, create `.planning/phases/03-live-streaming-integration/03-04-SUMMARY.md` following the summary template.
</output>
